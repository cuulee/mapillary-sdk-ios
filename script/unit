#!/bin/bash

CURRENT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PARRENT_DIR="$(dirname "$current_dir")"

cd MapillarySDK

echo "Generating workspace"
export LANG=en_US.UTF-8
/usr/local/bin/pod install

cd ..

echo "Running tests..."
xcodebuild test-without-building \
           -workspace MapillarySDK/MapillarySDK.xcworkspace \
           -scheme Test \
           -configuration Debug \
           -destination 'platform=iOS Simulator,OS=11.4,name=iPhone 6' 2>&1 | /usr/local/bin/ocunit2junit

RC=$?

echo "Collecting code coverage..."
/usr/local/bin/slather

echo "Copying reports..."
mkdir -p test_results/unit
mkdir -p test_results/cobertura
cp -a test-reports/. test_results/unit/
cp -a cobertura/cobertura.xml test_results/cobertura/coverage.xml
rm -rf test-reports
rm -rf cobertura

if [ $RC = 0 ]; then
    echo "Unit tests passed"
    exit $RC
else
    echo "Unit tests failed"
    exit $RC
